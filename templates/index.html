<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkBrain 智能体模型V2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked@4.2.3/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
    <style>
        :root {
            --bg-color: #f7f7f8;
            --text-color: #374151;
            --user-bg: #e8f5e9;
            --user-text: #1e3a29;
            --assistant-bg: #ffffff;
            --tool-bg: #e9f0ff;
            --tool-text: #3b5998;
            --input-bg: #ffffff;
            --border-color: #e5e7eb;
            --accent-color: #10b981;
            --hover-color: #059669;
            --error-color: #ef4444;
            --muted-color: #6b7280;
            --chat-border: #eaecef;
            --header-bg: #ffffff;
            --sidebar-color: #f7f7f8;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', ui-sans-serif, system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5;
            overflow: hidden;
        }

        .chat-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }

        .header {
            padding: 16px 0;
            text-align: center;
            border-bottom: 1px solid var(--chat-border);
            background-color: var(--header-bg);
            margin-bottom: 0;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            color: #1f2937;
        }
        
        .header .clear-history-btn {
            position: absolute;
            right: 16px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .header .clear-history-btn:hover {
            background-color: var(--hover-color);
        }

        .chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            scroll-behavior: smooth;
            background-color: var(--bg-color);
        }

        .message-group {
            margin: 0;
            padding: 16px 0;
        }

        .message-row {
            position: relative;
            padding: 8px 32px;
        }

        .message-row.user {
            background-color: transparent;
        }

        .message-row.assistant, .message-row.tool {
            background-color: transparent;
        }

        .message {
            max-width: 85%;
            margin-left: 50px;
            position: relative;
        }

        .message-bubble {
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            background-color: var(--assistant-bg);
        }

        .user .message-bubble {
            background-color: var(--user-bg);
            color: var(--user-text);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .assistant .message-bubble {
            background-color: var(--assistant-bg);
            color: var(--text-color);
            border-bottom-left-radius: 4px;
        }

        .tool .message-bubble {
            background-color: var(--tool-bg);
            color: var(--tool-text);
            border-bottom-left-radius: 4px;
        }

        .message-content {
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 15px;
            line-height: 1.6;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            left: 32px;
            top: 8px;
            font-weight: bold;
            color: white;
            font-size: 14px;
            z-index: 2;
        }

        .user .avatar {
            background-color: #10b981;
        }

        .tool .avatar {
            background-color: #4f46e5;
        }

        .user .message {
            margin-left: auto;
            margin-right: 50px;
        }

        .message-meta {
            font-size: 12px;
            color: var(--muted-color);
            margin-top: 4px;
            padding: 0 4px;
        }

        .assistant .message-meta, .tool .message-meta {
            margin-left: 16px;
        }

        .user .message-meta {
            text-align: right;
            margin-right: 16px;
        }

        .chat-input-container {
            position: relative;
            padding: 16px 32px;
            margin-top: auto;
            border-top: 1px solid var(--chat-border);
            background-color: white;
            z-index: 10;
        }

        .chat-input {
            background-color: var(--input-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            position: relative;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        textarea.form-control {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: none;
            box-shadow: none;
            resize: none;
            padding: 12px 45px 12px 16px;
            font-size: 15px;
            line-height: 1.5;
            height: 48px;
            max-height: 200px;
            border-radius: 12px;
        }

        textarea.form-control:focus {
            background-color: var(--input-bg);
            color: var(--text-color);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
            border-color: var(--accent-color);
        }

        .input-buttons {
            position: absolute;
            bottom: 8px;
            right: 14px;
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: transparent;
            border: none;
            color: var(--muted-color);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color);
        }

        .btn-send {
            background-color: var(--accent-color);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-send:hover {
            background-color: var(--hover-color);
        }

        .btn-send:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }

        .media-preview {
            max-width: 100%;
            max-height: 500px;
            border-radius: 8px;
            margin: 8px 0;
            display: block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .media-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }

        .media-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .media-item img, .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-item .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(255, 255, 255, 0.9);
            color: #374151;
            border: 1px solid #e5e7eb;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2;
        }

        .audio-icon, .video-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            font-size: 30px;
            color: var(--accent-color);
            background-color: #f3f4f6;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 0;
            margin-left: 8px;
        }

        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: var(--accent-color);
            display: inline-block;
            border-radius: 50%;
            opacity: 0.6;
            animation: typing 1.4s infinite both;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        .status-bar {
            font-size: 0.8rem;
            color: var(--muted-color);
            text-align: center;
            padding: 8px 0;
        }

        @keyframes typing {
            0% { transform: translateY(0); opacity: 0.6; }
            50% { transform: translateY(-5px); opacity: 1; }
            100% { transform: translateY(0); opacity: 0.6; }
        }

        /* 分组样式 */
        .message-date-divider {
            text-align: center;
            position: relative;
            margin: 24px 0 12px;
            z-index: 1;
        }

        .message-date-divider::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            border-top: 1px solid var(--border-color);
            z-index: -1;
        }

        .message-date-divider span {
            background: var(--bg-color);
            padding: 0 16px;
            font-size: 12px;
            color: var(--muted-color);
        }

        /* 媒体查询，移动设备适配 */
        @media (max-width: 768px) {
            .message-row {
                padding: 8px 16px;
            }
            
            .avatar {
                left: 16px;
            }
            
            .chat-input-container {
                padding: 12px 16px;
            }
            
            .message {
                max-width: 75%;
            }
        }

        /* 美化滚动条 */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f9fafb;
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* 添加Markdown样式 */
        .markdown-content {
            line-height: 1.6;
        }
        .markdown-content h1 {
            font-size: 1.5rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .markdown-content h2 {
            font-size: 1.3rem;
            margin-top: 0.8rem;
            margin-bottom: 0.4rem;
            font-weight: 600;
        }
        .markdown-content h3 {
            font-size: 1.1rem;
            margin-top: 0.6rem;
            margin-bottom: 0.3rem;
            font-weight: 600;
        }
        .markdown-content p {
            margin-bottom: 0.5rem;
        }
        .markdown-content pre {
            background-color: #f6f8fa;
            border-radius: 6px;
            padding: 10px;
            overflow-x: auto;
            margin-bottom: 0.5rem;
        }
        .markdown-content code {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace;
            font-size: 0.9em;
            background-color: rgba(175, 184, 193, 0.2);
            padding: 0.2em 0.4em;
            border-radius: 6px;
        }
        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
        }
        .markdown-content blockquote {
            padding-left: 1em;
            border-left: 4px solid #dfe2e5;
            color: #6a737d;
            margin-bottom: 0.5rem;
        }
        .markdown-content ul, .markdown-content ol {
            padding-left: 1.5em;
            margin-bottom: 0.5rem;
        }
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 0.5rem;
        }
        .markdown-content table th, .markdown-content table td {
            border: 1px solid #dfe2e5;
            padding: 6px 13px;
        }
        .markdown-content table th {
            background-color: #f6f8fa;
        }
        .tool-result {
            margin: 10px 0;
        }

        .text-content {
            margin-top: 10px;
        }

        .error-message {
            color: var(--error-color);
            font-size: 14px;
            padding: 8px;
            text-align: center;
            background-color: #fee2e2;
            border-radius: 6px;
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid chat-container">
        <div class="header">
            <h2>WorkBrain 智能体模型V2.0</h2>
            <button class="clear-history-btn">清除对话历史</button>
        </div>
        
        <div class="chat-box" id="chatBox">
            <!-- 消息将在这里动态添加 -->
        </div>
        
        <div class="chat-input-container">
            <div class="media-list" id="mediaList">
                <!-- 上传的多媒体文件预览将在这里显示 -->
            </div>
            
            <div class="chat-input">
                <textarea class="form-control" id="messageInput" placeholder="输入您的问题..." rows="1"></textarea>
                <div class="input-buttons">
                    <button class="btn-icon" id="uploadButton" title="上传文件">
                        <i class="bi bi-paperclip"></i>
                    </button>
                    <button class="btn-send" id="sendButton" title="发送">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
                <input type="file" id="fileInput" style="display: none;" accept="image/*,audio/*,video/*">
            </div>
            
            <div class="status-bar" id="statusBar">
                <span>已连接</span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const socket = io();
            const chatBox = document.getElementById('chatBox');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const statusBar = document.getElementById('statusBar');
            const fileInput = document.getElementById('fileInput');
            const uploadButton = document.getElementById('uploadButton');
            const mediaList = document.getElementById('mediaList');
            const clearHistoryBtn = document.querySelector('.clear-history-btn');
            
            // 自动调整文本区高度
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                // 限制最大高度
                if (this.scrollHeight > 200) {
                    this.style.overflowY = 'auto';
                } else {
                    this.style.overflowY = 'hidden';
                }
            });
            
            // 存储上传的文件信息
            const uploadedFiles = [];
            let isWaitingForResponse = false;
            
            // 连接Socket.IO
            socket.on('connect', function() {
                console.log("已连接到WebSocket服务器");
                updateStatus('已连接到服务器');
            });
            
            socket.on('disconnect', function() {
                console.log("WebSocket连接已断开");
                updateStatus('已断开连接', true);
            });
            
            socket.on('status', function(data) {
                console.log("状态更新:", data.message);
                updateStatus(data.message);
            });
            
            socket.on('error', function(data) {
                console.error("错误:", data.message);
                updateStatus(data.message, true);
                endTypingIndicator();
            });
            
            let typingRow = null;
            let currentAssistantMessage = null;
            
            function startTypingIndicator() {
                if (!typingRow) {
                    typingRow = document.createElement('div');
                    typingRow.className = 'message-row assistant';
                    
                    const avatar = document.createElement('div');
                    avatar.className = 'avatar';
                    avatar.textContent = 'AI';
                    
                    const message = document.createElement('div');
                    message.className = 'message';
                    
                    const messageBubble = document.createElement('div');
                    messageBubble.className = 'message-bubble';
                    
                    const typingIndicator = document.createElement('div');
                    typingIndicator.className = 'typing-indicator';
                    typingIndicator.innerHTML = '<span></span><span></span><span></span>';
                    
                    messageBubble.appendChild(typingIndicator);
                    message.appendChild(messageBubble);
                    typingRow.appendChild(avatar);
                    typingRow.appendChild(message);
                    
                    chatBox.appendChild(typingRow);
                    scrollToBottom();
                }
            }
            
            function endTypingIndicator() {
                if (typingRow) {
                    chatBox.removeChild(typingRow);
                    typingRow = null;
                }
                isWaitingForResponse = false;
                sendButton.disabled = false;
                currentAssistantMessage = null;
            }
            
            // 接收消息
            socket.on('message', function(data) {
                console.log("收到消息:", data.type, data.media_type || 'text', data);
                
                // 处理流式回复
                if (data.type === 'assistant' && !data.media_type && !data.is_tool_result) {
                    // 检查是否已经有正在处理的助手消息
                    if (!currentAssistantMessage) {
                        // 如果存在输入指示器，删除它
                        if (typingRow) {
                            chatBox.removeChild(typingRow);
                            typingRow = null;
                        }
                        
                        // 创建新的消息行
                        currentAssistantMessage = createAssistantMessageRow();
                        accumulatedMarkdown = '';
                    }
                    
                    // 追加内容到现有助手消息
                    appendToAssistantMessage(currentAssistantMessage, data.content);
                    
                    // 滚动到底部
                    scrollToBottom();
                    return;
                }
                
                // 检查是否是多模态分析工具的结果
                if (data.type === 'assistant' && data.is_tool_result && data.tool_name === 'analyze_multimodal_content') {
                    // 如果存在输入指示器，删除它
                    if (typingRow) {
                        chatBox.removeChild(typingRow);
                        typingRow = null;
                    }
                    
                    // 创建新的消息行
                    const messageRow = document.createElement('div');
                    messageRow.className = 'message-row assistant';
                    
                    const avatar = document.createElement('div');
                    avatar.className = 'avatar';
                    avatar.textContent = 'AI';
                    
                    const message = document.createElement('div');
                    message.className = 'message';
                    
                    const messageBubble = document.createElement('div');
                    messageBubble.className = 'message-bubble';
                    
                    const messageContent = document.createElement('div');
                    messageContent.className = 'message-content markdown-content';
                    
                    // 多模态工具结果是纯文本，使用marked渲染
                    messageContent.innerHTML = marked.parse(data.content || '');
                    
                    // 应用代码高亮
                    messageContent.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                    
                    messageBubble.appendChild(messageContent);
                    message.appendChild(messageBubble);
                    
                    // 添加时间戳
                    const now = new Date();
                    const time = now.getHours().toString().padStart(2, '0') + ':' + 
                                now.getMinutes().toString().padStart(2, '0');
                    
                    const messageMeta = document.createElement('div');
                    messageMeta.className = 'message-meta';
                    messageMeta.textContent = time;
                    message.appendChild(messageMeta);
                    
                    messageRow.appendChild(avatar);
                    messageRow.appendChild(message);
                    chatBox.appendChild(messageRow);
                    
                    // 滚动到底部
                    scrollToBottom();
                    return;
                }
                
                // 媒体内容或非流式回复的处理
                // 如果存在输入指示器，删除它
                if (typingRow) {
                    chatBox.removeChild(typingRow);
                    typingRow = null;
                }
                
                // 创建新的消息行
                const messageRow = document.createElement('div');
                messageRow.className = 'message-row';
                
                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                
                const message = document.createElement('div');
                message.className = 'message';
                
                const messageBubble = document.createElement('div');
                messageBubble.className = 'message-bubble';
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                
                // 处理根据消息类型处理
                if (data.type === 'user') {
                    messageRow.classList.add('user');
                    avatar.textContent = '你';
                    
                    // 处理用户媒体内容
                    if (data.has_combined) {
                        console.log("处理用户组合内容:", data);
                        
                        // 处理媒体内容
                        if (data.media_type && data.media_content) {
                            console.log("处理用户媒体:", data.media_type);
                            let mediaHtml = renderMediaContent(data.media_type, data.media_content);
                            messageContent.innerHTML = mediaHtml;
                            
                            // 如果同时有文本内容，添加到媒体下方
                            if (data.content && data.content.trim()) {
                                messageContent.innerHTML += `<div class="text-content">${data.content}</div>`;
                            }
                        } else {
                            // 纯文本内容
                            messageContent.textContent = data.content || '';
                        }
                    } else {
                        // 向后兼容旧的纯文本消息
                        messageContent.textContent = data.content || '';
                    }
                    
                } else if (data.type === 'assistant') {
                    messageRow.classList.add('assistant');
                    avatar.textContent = 'AI';
                    
                    // 检查是否是多模态分析工具的结果
                    if (data.is_tool_result && data.tool_name === 'analyze_multimodal_content') {
                        console.log("处理多模态分析结果");
                        
                        // 多模态工具结果是文本，使用Markdown渲染
                        messageContent.innerHTML = marked.parse(data.content || '');
                        messageContent.classList.add('markdown-content');
                        
                        // 应用代码高亮
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    } 
                    // 处理其他媒体内容
                    else if (data.media_type && data.media_content) {
                        console.log("处理助手媒体内容:", data.media_type);
                        let mediaHtml = renderMediaContent(data.media_type, data.media_content);
                        messageContent.innerHTML = mediaHtml;
                        
                        // 如果同时有文本内容，添加到媒体下方
                        if (data.content) {
                            messageContent.innerHTML += `<div class="text-content">${marked.parse(data.content)}</div>`;
                        }
                        
                        messageContent.classList.add('markdown-content');
                    } else {
                        // 纯文本/Markdown内容
                        messageContent.innerHTML = marked.parse(data.content || '');
                        messageContent.classList.add('markdown-content');
                    }
                } else if (data.type === 'tool') {
                    messageRow.classList.add('tool');
                    avatar.classList.add('tool');
                    avatar.textContent = '工具';
                    
                    // 检查是否是媒体内容
                    if (data.media_type) {
                        messageContent.innerHTML = renderMediaContent(data.media_type, data.content);
                    } else {
                        // 使用marked.js渲染工具消息中的Markdown
                        messageContent.innerHTML = marked.parse(data.content || '');
                        messageContent.classList.add('markdown-content');
                        // 应用代码高亮
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
                
                messageBubble.appendChild(messageContent);
                message.appendChild(messageBubble);
                
                // 添加消息时间
                const now = new Date();
                const time = now.getHours().toString().padStart(2, '0') + ':' + 
                            now.getMinutes().toString().padStart(2, '0');
                            
                const messageMeta = document.createElement('div');
                messageMeta.className = 'message-meta';
                messageMeta.textContent = time;
                message.appendChild(messageMeta);
                
                messageRow.appendChild(avatar);
                messageRow.appendChild(message);
                chatBox.appendChild(messageRow);
            });
            
            // 完成响应时重置当前消息
            socket.on('response_complete', function() {
                endTypingIndicator();
                // 重置消息状态
                currentAssistantMessage = null;
                accumulatedMarkdown = '';
                scrollToBottom();
            });
            
            function createAssistantMessageRow() {
                const messageRow = document.createElement('div');
                messageRow.className = 'message-row assistant';
                
                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                avatar.textContent = 'AI';
                
                const message = document.createElement('div');
                message.className = 'message';
                
                const messageBubble = document.createElement('div');
                messageBubble.className = 'message-bubble';
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                
                messageBubble.appendChild(messageContent);
                message.appendChild(messageBubble);
                messageRow.appendChild(avatar);
                messageRow.appendChild(message);
                chatBox.appendChild(messageRow);
                
                return messageContent;
            }
            
            // 使用这个变量来累积Markdown内容
            let accumulatedMarkdown = '';
            
            function appendToAssistantMessage(messageElement, content) {
                if (!content) return;
                
                // 累积Markdown内容
                accumulatedMarkdown += content;
                
                // 使用marked渲染累积的Markdown内容
                messageElement.innerHTML = marked.parse(accumulatedMarkdown);
                messageElement.classList.add('markdown-content');
                
                // 应用代码高亮
                messageElement.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                
                // 滚动到底部以显示新内容
                scrollToBottom();
            }
            
            // 发送消息
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            function sendMessage() {
                if (isWaitingForResponse) {
                    updateStatus('请等待上一条消息的响应完成', true);
                    return;
                }
                
                const messageText = messageInput.value.trim();
                if (!messageText && uploadedFiles.length === 0) {
                    return;
                }
                
                // 不再自己添加用户消息，由后端统一处理并返回
                // appendMessage({
                //    type: 'user',
                //    content: messageText
                // });
                
                // 开始等待响应
                isWaitingForResponse = true;
                sendButton.disabled = true;
                startTypingIndicator();
                
                // 准备发送的消息数据
                let messageData = { 'message': messageText };
                
                // 如果有上传的文件
                if (uploadedFiles.length > 0) {
                    console.log("发送消息包含媒体文件:", uploadedFiles.length);
                    messageData.media_files = {
                        'has_media': true,
                        'files': uploadedFiles.map(file => ({
                            'path': file.path,
                            'type': file.type
                        }))
                    };
                }
                
                console.log("发送消息到服务器:", messageData);
                socket.emit('message', messageData);
                
                // 清空输入
                messageInput.value = '';
                messageInput.style.height = '48px';
                clearMediaList();
            }
            
            // 文件上传功能
            uploadButton.addEventListener('click', function() {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', handleFileUpload);
            
            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                console.log("选择的文件:", file.name, file.type, file.size);
                
                const formData = new FormData();
                formData.append('file', file);
                
                updateStatus('正在上传文件...');
                
                console.log("开始上传文件");
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    console.log("上传响应状态:", response.status);
                    return response.json();
                })
                .then(data => {
                    console.log("上传响应数据:", data);
                    if (data.success) {
                        // 添加到上传文件列表
                        uploadedFiles.push({
                            name: file.name,
                            path: data.file_path,
                            url: data.file_url,
                            type: data.file_type
                        });
                        
                        console.log("文件已添加到列表:", uploadedFiles);
                        
                        // 显示文件预览
                        displayMediaPreview(file, data.file_url, data.file_type);
                        updateStatus('文件上传成功');
                    } else {
                        console.error("上传失败:", data.error);
                        updateStatus('文件上传失败: ' + data.error, true);
                    }
                })
                .catch(error => {
                    console.error("上传出错:", error);
                    updateStatus('文件上传出错: ' + error.message, true);
                });
                
                // 清空文件输入以允许重复选择相同文件
                fileInput.value = '';
            }
            
            function displayMediaPreview(file, url, type) {
                const mediaItem = document.createElement('div');
                mediaItem.className = 'media-item';
                mediaItem.setAttribute('data-url', url);
                
                let content = '';
                
                if (type === 'image') {
                    content = `<img src="${url}" alt="${file.name}">`;
                } else if (type === 'audio') {
                    content = `<div class="audio-icon"><i class="bi bi-music-note"></i></div>`;
                } else if (type === 'video') {
                    content = `<div class="video-icon"><i class="bi bi-camera-video"></i></div>`;
                }
                
                const removeButton = `<button class="remove-btn" data-url="${url}">×</button>`;
                
                mediaItem.innerHTML = content + removeButton;
                mediaList.appendChild(mediaItem);
                
                // 添加删除按钮事件
                mediaItem.querySelector('.remove-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const urlToRemove = this.getAttribute('data-url');
                    removeMedia(urlToRemove);
                });
            }
            
            function removeMedia(url) {
                const index = uploadedFiles.findIndex(file => file.url === url);
                if (index !== -1) {
                    uploadedFiles.splice(index, 1);
                }
                
                const mediaItems = mediaList.querySelectorAll('.media-item');
                mediaItems.forEach(item => {
                    if (item.getAttribute('data-url') === url) {
                        mediaList.removeChild(item);
                    }
                });
            }
            
            function clearMediaList() {
                uploadedFiles.length = 0;
                mediaList.innerHTML = '';
            }
            
            // 媒体内容处理函数
            function renderMediaContent(mediaType, mediaUrl) {
                console.log(`渲染媒体内容: ${mediaType}, URL长度: ${mediaUrl ? mediaUrl.length : 0}`);
                
                if (!mediaUrl) {
                    return '<div class="error-message">媒体内容不可用</div>';
                }
                
                try {
                    if (mediaType === 'image') {
                        return `<img src="${mediaUrl}" class="media-preview" alt="图片" 
                                onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'error-message\'>图片加载失败</div>';">`;
                    } else if (mediaType === 'audio') {
                        return `<audio controls class="media-preview"><source src="${mediaUrl}"></audio>`;
                    } else if (mediaType === 'video') {
                        return `<video controls class="media-preview"><source src="${mediaUrl}"></video>`;
                    }
                } catch (e) {
                    console.error("渲染媒体内容出错:", e);
                    return `<div class="error-message">媒体内容渲染失败: ${e.message}</div>`;
                }
                
                return '';
            }
            
            // 修改添加消息到聊天界面的函数
            function appendMessage(data) {
                // 如果存在输入指示器，删除它
                if (typingRow) {
                    chatBox.removeChild(typingRow);
                    typingRow = null;
                }
                
                // 对于AI消息，如果正在流式处理，不创建新元素
                if (data.type === 'assistant' && currentAssistantMessage) {
                    return;
                }
                
                const messageRow = document.createElement('div');
                messageRow.className = 'message-row';
                
                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                
                const message = document.createElement('div');
                message.className = 'message';
                
                const messageBubble = document.createElement('div');
                messageBubble.className = 'message-bubble';
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                
                if (data.type === 'user') {
                    messageRow.classList.add('user');
                    avatar.classList.add('user');
                    avatar.textContent = '你';
                    
                    // 处理组合消息（文本+媒体）
                    if (data.has_combined) {
                        console.log("渲染组合消息:", data);
                        let content = '';
                        
                        // 添加媒体内容（如果有）
                        if (data.media_type && data.media_content) {
                            content += renderMediaContent(data.media_type, data.media_content);
                        } else if (data.media_type === 'audio' && !data.media_content) {
                            // 特殊处理仅有音频描述但没有实际内容的情况
                            content += `<div class="audio-icon"><i class="bi bi-music-note" style="font-size: 3em;"></i></div>`;
                        }
                        
                        // 添加文本内容（如果有）
                        if (data.content && data.content.trim()) {
                            // 如果有媒体内容，增加一些间距
                            if ((data.media_content || data.media_type === 'audio') && !content.includes("<div")) {
                                content += `<div style="margin-top: 10px;"></div>`;
                            }
                            content += `<div>${data.content}</div>`;
                        }
                        
                        messageContent.innerHTML = content;
                    }
                    // 处理普通消息
                    else if (data.media_type) {
                        // 单纯的媒体消息
                        messageContent.innerHTML = renderMediaContent(data.media_type, data.content);
                    } else {
                        // 纯文本消息
                        messageContent.textContent = data.content;
                    }
                } else if (data.type === 'assistant') {
                    messageRow.classList.add('assistant');
                    avatar.textContent = 'AI';
                    
                    // 首先检查是否是工具结果
                    if (data.is_tool_result) {
                        console.log("处理工具结果:", data);  // 添加调试日志
                        if (data.media_type === 'image') {
                            messageContent.innerHTML = `
                                <div class="tool-result">
                                    <img src="${data.media_content}" class="media-preview" alt="生成的图片" 
                                         onerror="console.error('图片加载失败:', this.src)"/>
                                </div>`;
                        }
                    } else {
                        // 处理普通的助手消息
                        if (data.media_type && data.media_content) {
                            // 处理媒体内容
                            if (data.media_type === 'image') {
                                messageContent.innerHTML = `
                                    <img src="${data.media_content}" class="media-preview" alt="图片" 
                                         onerror="console.error('图片加载失败:', this.src)"/>`;
                            }
                            // 如果还有文本内容，添加到媒体下方
                            if (data.content) {
                                messageContent.innerHTML += `<div class="text-content">${marked.parse(data.content)}</div>`;
                            }
                        } else {
                            // 纯文本内容
                    messageContent.innerHTML = marked.parse(data.content || '');
                        }
                    }
                    
                    // 添加调试信息
                    console.log("渲染的消息内容:", messageContent.innerHTML);
                } else if (data.type === 'tool') {
                    messageRow.classList.add('tool');
                    avatar.classList.add('tool');
                    avatar.textContent = '工具';
                    
                    // 检查是否是媒体内容
                    if (data.media_type) {
                        messageContent.innerHTML = renderMediaContent(data.media_type, data.content);
                    } else {
                        // 使用marked.js渲染工具消息中的Markdown
                        messageContent.innerHTML = marked.parse(data.content || '');
                        messageContent.classList.add('markdown-content');
                        // 应用代码高亮
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
                
                messageBubble.appendChild(messageContent);
                message.appendChild(messageBubble);
                
                // 添加消息时间
                const now = new Date();
                const time = now.getHours().toString().padStart(2, '0') + ':' + 
                            now.getMinutes().toString().padStart(2, '0');
                            
                const messageMeta = document.createElement('div');
                messageMeta.className = 'message-meta';
                messageMeta.textContent = time;
                message.appendChild(messageMeta);
                
                messageRow.appendChild(avatar);
                messageRow.appendChild(message);
                chatBox.appendChild(messageRow);
            }
            
            // 更新状态栏
            function updateStatus(message, isError = false) {
                statusBar.textContent = message;
                statusBar.style.color = isError ? 'var(--error-color)' : 'var(--muted-color)';
            }
            
            // 滚动到底部
            function scrollToBottom() {
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            // 绑定清除历史按钮事件
            clearHistoryBtn.addEventListener('click', function() {
                if (isWaitingForResponse) {
                    updateStatus('请等待当前响应完成后再清除历史', true);
                    return;
                }
                
                if (confirm('确定要清除所有对话历史吗？')) {
                    fetch('/clear-history', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // 清空对话界面
                            chatBox.innerHTML = '';
                            updateStatus('对话历史已清除');
                        } else {
                            updateStatus('清除历史失败: ' + data.message, true);
                        }
                    })
                    .catch(error => {
                        console.error('清除历史出错:', error);
                        updateStatus('清除历史出错: ' + error.message, true);
                    });
                }
            });

            // 添加图片加载错误处理
            window.addEventListener('error', function(e) {
                if (e.target.tagName === 'IMG') {
                    console.error('图片加载失败:', e.target.src);
                    e.target.style.display = 'none';
                    e.target.insertAdjacentHTML('afterend', 
                        '<div class="error-message">图片加载失败</div>');
                }
            }, true);
        });
    </script>
</body>
</html> 